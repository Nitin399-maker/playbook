<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mixed Content PDF Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* Global 20% size reduction */
        html { font-size: 80%; }
        body { 
            background-color: #f8f9fa; 
            padding-top: 12px; 
            padding-bottom: 16px; 
            transform-origin: top center;
        }
        #pageContent { max-width: 100%; overflow-x: auto; position: relative; }
        .upload-area { border: 2px dashed #dee2e6; border-radius: 6px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .upload-area:hover { background-color: #f1f3f5; border-color: #adb5bd; }
        .progress-container { max-width: 560px; margin: 0 auto; }
        /* Tree Visualization Styles */
        .tree-node { margin-bottom: 10px; padding: 6px; border-radius: 5px; border-left: 2px solid #0d6efd; background-color: #f8f9fa; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; }
        .tree-node.current { border-left-color: #198754; background-color: #e8f5e9; }
        .tree-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; font-weight: 500; }
        .tree-badge { font-size: 0.65rem; }
        .tree-connector { margin: 5px 0; border-left: 2px dashed #dee2e6; height: 8px; margin-left: 6px; }
        .tree-options { margin-left: 12px; }
        .tree-option { background-color: white; padding: 3px 6px; margin-bottom: 3px; border-radius: 3px; border: 1px solid #dee2e6; display: flex; align-items: center; cursor: pointer; }
        .tree-option:hover { background-color: #f8f9fa; }
        .tree-option.selected { border: 1px solid #198754; background-color: #f0f9f4; }
        .option-arrow { color: #0d6efd; margin-right: 5px; font-weight: bold; }
        .option-arrow.text-success { color: #198754; }
        .selected-option { font-size: 0.8rem; margin-top: -6px; margin-bottom: 6px; }
        .tree-container { max-height: 480px; overflow: auto; font-size: 0.8rem; }
        .processing-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .step { flex: 1; text-align: center; padding: 5px 6px; position: relative; font-weight: 500; font-size: 0.7rem; }
        .step.active { background-color: #e9f2ff; border-color: #0d6efd; color: #0d6efd; }
        .step.completed { background-color: #d4edda; border-color: #28a745; color: #28a745; }
        .chunk-preview { max-width: 240px; max-height: 160px; margin-top: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .settings-panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .settings-panel.show { max-height: 800px; }
        .page-type-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }
    </style>
</head>
<body>
    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white py-2">
                        <h1 class="h4 mb-0 text-center">Mixed Content PDF Processor</h1>
                        <p class="mb-0 text-center small">Automatically processes both static content and decision trees within the same document</p>
                    </div>

                    <div class="card-body">
                        <!-- API Key Input -->
                        <div class="mb-3">
                            <label for="apiKey" class="form-label fw-bold">API Key:</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="apiKey" placeholder="Enter your OpenRouter API key">
                                <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">Your API key is used locally and not stored on any server.</div>
                        </div>

                        <!-- Advanced Settings Toggle -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold">Advanced Settings</h6>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleSettings">
                                <i class="bi bi-gear"></i> Configure
                            </button>
                        </div>
                        
                        <!-- Advanced Settings Panel -->
                        <div class="settings-panel mb-3" id="settingsPanel">
                            <div class="card">
                                <div class="card-body">
                                    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="static-tab" data-bs-toggle="tab" data-bs-target="#static-settings" type="button" role="tab">
                                                Static Content
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="decision-tab" data-bs-toggle="tab" data-bs-target="#decision-settings" type="button" role="tab">
                                                Decision Tree
                                            </button>
                                        </li>
                                    </ul>
                                    <div class="tab-content pt-2" id="settingsTabContent">
                                        <!-- Static Content Settings -->
                                        <div class="tab-pane fade show active" id="static-settings" role="tabpanel">
                                            <div class="mb-3">
                                                <label class="form-label">Static Content Prompt:</label>
                                                <textarea class="form-control" id="staticPrompt" rows="4">Convert this PDF page to clean, semantic HTML. Preserve all content, formatting, and layout. Use appropriate HTML5 tags and Bootstrap classes. Include all text, preserve headings, maintain paragraph structure, and recreate tables accurately.</textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Decision Tree Settings -->
                                        <div class="tab-pane fade" id="decision-settings" role="tabpanel">
                                            <div class="mb-3">
                                                <label class="form-label">Extraction Prompt:</label>
                                                <textarea class="form-control" id="extractionPrompt" rows="7"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Node Schema:</label>
                                                <textarea class="form-control font-monospace" id="schemaEditor" rows="4"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Area -->
                        <div class="upload-area mb-3" id="uploadArea">
                            <div class="text-center">
                                <i class="bi bi-file-earmark-pdf text-primary" style="font-size: 2.4rem;"></i>
                                <h6 class="mt-2">Drop your mixed-content PDF here or click to browse</h6>
                                <p class="text-muted small">The system will analyze each page individually to determine if it's static content or a decision tree</p>
                                <input type="file" id="pdfUpload" class="d-none" accept=".pdf">
                                <button class="btn btn-primary px-3" id="browseButton">Browse Files</button>
                            </div>
                        </div>

                        <!-- Processing Progress -->
                        <div id="progressArea" class="progress-container mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold" id="processingTitle">Processing PDF...</span>
                                <span class="badge bg-primary" id="progressText">0%</span>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                            </div>
                            <div id="processingStatus" class="small text-muted"></div>
                            
                            <!-- Processing Steps -->
                            <div class="d-flex mt-2">
                                <div class="step border rounded-start p-2" id="step-1">1. Analysis</div>
                                <div class="step border-top border-bottom p-2" id="step-2">2. Classification</div>
                                <div class="step border-top border-bottom p-2" id="step-3">3. Processing</div>
                                <div class="step border rounded-end p-2" id="step-4">4. Rendering</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Viewer (Combined) -->
                <div id="contentViewer" class="card shadow-sm" style="display: none;">
                    <div class="card-header bg-white py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 id="pageTitle" class="h5 mb-0 d-inline">Page 1</h4>
                                <span id="pageTypeIndicator" class="page-type-badge bg-info text-white">Static</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <span id="pageCounter" class="text-muted me-3">Page 1 of 1</span>
                                <div class="input-group" style="width: 160px;">
                                    <input type="number" min="1" class="form-control" id="pageInput" placeholder="Go to page">
                                    <button class="btn btn-outline-primary" id="goToPage">Go</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Static Content Section -->
                    <div id="staticContent">
                        <div class="card-body">
                            <div id="pageContent" class="pb-4"></div>
                        </div>
                    </div>
                    
                    <!-- Decision Tree Section -->
                    <div id="treeContent" style="display: none;">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-primary me-1" id="restartBtn">
                                    <i class="bi bi-arrow-repeat me-1"></i>Restart
                                </button>
                                <button class="btn btn-sm btn-outline-primary me-1" id="exportJsonBtn">
                                    <i class="bi bi-download me-1"></i>Export JSON
                                </button>
                                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="expandTreeBtn">
                                    <i class="bi bi-arrows-expand"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary py-0 px-2" id="collapseTreeBtn">
                                    <i class="bi bi-arrows-collapse"></i>
                                </button>
                            </div>
                            <div id="treeVisualization" class="tree-container">
                                <!-- Tree will be rendered here dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Navigation Footer -->
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between mt-2">
                            <button id="prevPage" class="btn btn-outline-primary" disabled>⬅️ Previous</button>
                            <button id="nextPage" class="btn btn-outline-primary" disabled>Next ➡️</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Processing...</span>
        </div>
        <h5 id="overlayStatus" class="mb-3">Analyzing PDF document...</h5>
        <div id="overlaySubstatus" class="text-muted mb-3"></div>
        <div class="progress w-50 mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="overlayProgress" style="width: 0%"></div>
        </div>
        <img id="chunkPreview" class="chunk-preview" style="display: none;">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="scripts.js" type="module"></script>
</body>
</html>